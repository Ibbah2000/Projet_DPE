---
title: "D√©fis Performance √©nerg√©tique"
author: "Kenny Jean Elie- Ibrahima Caba Bah- Nd√®ye Fatou Diop"
date: "2025-11-07"
output:
  flexdashboard::flex_dashboard:
    orientation: columns        # disposition en colonnes
    vertical_layout: fill       # ajuste √† la taille de l'√©cran
    theme: flatly     # th√®me clair et moderne
    highlight: tango            # style du code
runtime: shiny
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(ggpubr)
library(scales)
library(ggalluvial)
library(tidymodels)
library(randomForest)
library(broom)
library(stringr)
library(readr)  
library(flexdashboard)
library(readxl) 
library(dplyr)    
library(plotly)   
library(shiny)
library(bslib)
library(leaflet)
library(sf)
library(ggplot2)
library(ggiraph)
```



```{r}
# Charger les donn√©es
df<- read_csv("base_final.csv")
tarif_eur_par_kwh <- 0.20                     # hypoth√®se tarifaire (‚Ç¨ / kWh)
dpi_plot <- 300
dpe_levels <- c("A","B","C","D","E","F","G")

```

```{r echo=FALSE}

# Conversion en kWh
df <- df %>%
  mutate(
    conso_totale_kwh = `Consommation annuelle moyenne par logement de l'adresse (MWh)` * 1000,
    conso_moy_adresse_kwh = `Consommation annuelle moyenne par logement de l'adresse (MWh)`* 1000,
    conso_m2_kwh_an = if_else(!is.na(surface_habitable_logement) & surface_habitable_logement > 0,
                              conso_moy_adresse_kwh / surface_habitable_logement,
                              NA_real_)
  )

df <- df %>%
  mutate(etiquette_dpe = toupper(str_trim(etiquette_dpe)),
         etiquette_dpe = factor(if_else(etiquette_dpe %in% dpe_levels, etiquette_dpe, NA_character_),
                                levels = dpe_levels),
         type_energie = type_energie_n1)

stats_dpe <- df %>%
  group_by(etiquette_dpe) %>%
  summarise(
    n = n(),
    mean_kwh = mean(conso_moy_adresse_kwh, na.rm = TRUE),
    sd_kwh = sd(conso_moy_adresse_kwh, na.rm = TRUE),
    median_kwh = median(conso_moy_adresse_kwh, na.rm = TRUE),
    mean_kwh_m2 = mean(conso_m2_kwh_an, na.rm = TRUE)
  ) %>%
  arrange(etiquette_dpe)

# Calcul des gains moyens (diff√©rences) entre classes (en kWh/an et en euros)
# On produit une matrice de diff√©rences mean(class_i) - mean(class_j)
means <- stats_dpe %>% select(etiquette_dpe, mean_kwh) %>% drop_na()
mat_diff <- outer(means$mean_kwh, means$mean_kwh, "-")
rownames(mat_diff) <- means$etiquette_dpe
colnames(mat_diff) <- means$etiquette_dpe

# Sauvegarde tableau diff√©rences
diffs_df <- as_tibble(as.data.frame(mat_diff), rownames = "de_class") %>%
  pivot_longer(-de_class, names_to = "ala_class", values_to = "diff_kwh")
diffs_df <- diffs_df %>% mutate(diff_eur = diff_kwh * tarif_eur_par_kwh)


``` 

# Base {.sidebar}

### üéõÔ∏è Param√®tres de l'analyse

```{r}
selectInput("Annee",
            label = "Ann√©e d'analyse", 
            choices = unique(df$Ann√©e),
            selected = unique(df$Ann√©e)[1])
```

---

### üìä Indicateurs cl√©s
```{r , echo= FALSE}

  nb_inscrits_tour1 <- nrow(df)
```


```{r}

value_box(
  title = tags$span("Nombre de logements", style = "font-size: 16px; font-weight: bold;"),
  value = format(nb_inscrits_tour1, big.mark = " "),
  showcase = bsicons::bs_icon("house-fill"),
  theme = "bg-success"
)
 

```


---

### ‚ÑπÔ∏è √Ä propos

**Dashboard de performance √©nerg√©tique**

Ce tableau de bord pr√©sente une analyse compl√®te des performances √©nerg√©tiques des logements bas√©e sur les diagnostics de performance √©nerg√©tique (DPE).

**Tarif de r√©f√©rence:** 0,20 ‚Ç¨/kWh

---



### üìå L√©gende DPE

<div style="font-size: 12px;">
**Classes √©nerg√©tiques:**
- <span style="color: #00B050;">‚óè</span> **A** : Tr√®s performant
- <span style="color: #92D050;">‚óè</span> **B** : Performant
- <span style="color: #b8f774;">‚óè</span> **C** : Assez performant
- <span style="color: #FFFF00;">‚óè</span> **D** : Moyen
- <span style="color: #FFC000;">‚óè</span> **E** : Passable
- <span style="color: #ED7D31;">‚óè</span> **F** : M√©diocre
- <span style="color: #C00000;">‚óè</span> **G** : Tr√®s m√©diocre
</div>

# Diagnostic DPE et localisation

## Column {.tabset data-width=500}

### üìà R√©partition par DPE

```{r}
renderPlotly({
  # Filtrer les donn√©es selon l'ann√©e s√©lectionn√©e
  df_filtre <- df %>%
    filter(Ann√©e == input$Annee)
  
  # Calculer les statistiques sur les donn√©es filtr√©es
  resultats_groupes <- df_filtre %>%
    group_by(etiquette_dpe) %>%
    summarise(Nombre_obs = n()) %>%
    ungroup()
  
  total_obs <- sum(resultats_groupes$Nombre_obs)
  
  resultats_groupes <- resultats_groupes %>%
    mutate(Pourcentage = (Nombre_obs / total_obs) * 100)
  
  resultats_groupes$hover_text <- paste(
    "√âtiquette DPE : ", resultats_groupes$etiquette_dpe, "<br>",
    "Nombre d'observations : ", scales::comma(resultats_groupes$Nombre_obs), "<br>",
    "Pourcentage : ", round(resultats_groupes$Pourcentage, 2), "%"
  )
  
  ordre_dpe <- c("A", "B", "C", "D", "E", "F", "G", "Autres")
  resultats_groupes <- resultats_groupes %>%
    arrange(factor(etiquette_dpe, levels = ordre_dpe))
  
  couleurs_dpe <- c(
    "A" = "#1a9850", "B" = "#66bd63", "C" = "#a6d96a",
    "D" = "#fdae61", "E" = "#f46d43", "F" = "#d73027",
    "G" = "#a50026", "Autres" = "#BEBEBE"
  )
  
  # Cr√©er le graphique
  plot_ly(
    resultats_groupes,
    labels = ~etiquette_dpe,
    values = ~Pourcentage,
    type = 'pie',
    sort = FALSE,
    textinfo = 'label+percent',
    hoverinfo = 'text',
    text = ~hover_text,
    marker = list(
      colors = couleurs_dpe,
      line = list(color = '#FFFFFF', width = 1)
    ),
    insidetextorientation = 'horizontal',
    textposition = 'inside'
  ) %>%
    layout(
      title = list(
        text = paste("R√©partition des logements par √©tiquette DPE -", input$Annee),
        font = list(size = 18, color = 'black', family = 'Arial')
      ),
      showlegend = TRUE,
      legend = list(
        orientation = 'h',
        x = 0.5,
        xanchor = 'center',
        y = -0.1
      ),
      margin = list(t = 80, b = 60, l = 20, r = 20),
      pie = list(rotation = 180)
    ) %>%
    config(displayModeBar = FALSE)
})
```

### ‚ö° Consommation par type d'√©nergie

```{r}
renderPlotly({
  # Filtrer les donn√©es selon l'ann√©e s√©lectionn√©e
  df_filtre <- df %>%
    filter(Ann√©e == input$Annee)
  
  # Calculer les statistiques sur les donn√©es filtr√©es
  chauffage_stats <- df_filtre %>%
    group_by(type_energie) %>%
    summarise(
      n = n(),
      conso_moy = mean(conso_moy_adresse_kwh, na.rm = TRUE)
    ) %>%
    arrange(desc(conso_moy))
  
  # Cr√©er le graphique
  plot_ly(
    data = chauffage_stats,
    x = ~conso_moy,
    y = ~reorder(type_energie, conso_moy),
    type = 'bar',
    orientation = 'h',
    text = ~paste(
      "Type de chauffage :", type_energie, "<br>",
      "Consommation moyenne :", format(round(conso_moy, 0), big.mark = " "), "kWh<br>",
      "Nombre de logements :", format(n, big.mark = " ")
    ),
    hoverinfo = "text",
    textposition ="none",
    marker = list(
      color = ~conso_moy,
      colorscale = list(
        c(0, '#00B050'),
        c(0.5, '#FFC000'),
        c(1, '#C00000')
      ),
      showscale = FALSE,
      line = list(color = 'white', width = 1)
    )
  ) %>%
    layout(
      title = list(
        text = paste("Consommation moyenne selon le type de chauffage -", input$Annee),
        font = list(size = 18, family = 'Arial')
      ),
      xaxis = list(
        title = "Consommation (kWh/an)",
        titlefont = list(size = 14, family = 'Arial')
      ),
      yaxis = list(
        title = "",
        titlefont = list(size = 14, family = 'Arial')
      ),
      margin = list(t = 80, b = 60, l = 150, r = 40),
      plot_bgcolor = '#f8f9fa',
      paper_bgcolor = '#ffffff'
    ) %>%
    config(displayModeBar = FALSE)
})
```

### üìà Statistiques

```{r}
renderTable({
  stats_dpe %>%
    filter(!is.na(etiquette_dpe)) %>%
    select(
      Classe = etiquette_dpe,
      N = n,
      `Moyenne (kWh)` = mean_kwh,
      `M√©diane (kWh)` = median_kwh
    ) %>%
    mutate(
      `Moyenne (kWh)` = format(round(`Moyenne (kWh)`, 0), big.mark = " "),
      `M√©diane (kWh)` = format(round(`M√©diane (kWh)`, 0), big.mark = " "),
      N = format(N, big.mark = " ")
    )
}, striped = TRUE, hover = TRUE, bordered = TRUE, width = "100%")
```


### üó∫Ô∏èCartographie des Consommations 

```{r prep_map_base, include=FALSE}
# Charger la g√©om√©trie une seule fois (n√©cessaire pour la jointure)
france_departements <- st_read("https://static.data.gouv.fr/resources/carte-des-101-departements-francais-projetes-en-lambert-sous-la-metropole/20211121-183910/101deps-lambert.geojson")

# Assurer que la colonne de jointure (INSEE_DEP) est en format caract√®re
france_departements$INSEE_DEP <- as.character(france_departements$INSEE_DEP)
```

```{r echo=FALSE}
output$ma_carte_interactive <- renderGirafe({ 

    # --- 1. Filtrage et Agr√©gation ---
    df_departemental_reactive <- df %>%
      filter(Ann√©e == input$Annee) %>% 
      mutate(
        `Consommation annuelle totale de l'adresse (MWh)` = as.numeric(gsub(",", ".", `Consommation annuelle totale de l'adresse (MWh)`)),
        `Nombre de logements` = as.numeric(`Nombre de logements`)
      ) %>%
      group_by(`code_departement_ban`) %>%
      summarise(
        somme_conso_MWh = sum(`Consommation annuelle totale de l'adresse (MWh)`, na.rm = TRUE),
        somme_logements = sum(`Nombre de logements`, na.rm = TRUE),
        .groups = 'drop'
      ) %>%
      mutate(
        conso_moyenne_par_logement_MWh = round(somme_conso_MWh / somme_logements, 3)
      ) %>%
      rename(Code_Departement = `code_departement_ban`)

    df_departemental_reactive$Code_Departement <- as.character(df_departemental_reactive$Code_Departement)

    # Jointure
    france_departements_final_reactive <- merge(
      x = france_departements,
      y = df_departemental_reactive,
      by.x = "INSEE_DEP",
      by.y = "Code_Departement",
      all.x = TRUE
    )
    
    # *** √âTAPE CL√â : Calcul des Min et Max pour la l√©gende ***
    conso_data <- france_departements_final_reactive$conso_moyenne_par_logement_MWh
    min_conso <- min(conso_data, na.rm = TRUE)
    max_conso <- max(conso_data, na.rm = TRUE)
    
    # D√©finir les breaks pour inclure le min et le max, plus quelques valeurs interm√©diaires
    custom_breaks <- scales::pretty_breaks(n = 3)(c(min_conso, max_conso))
    
    # Assurer que le min et le max r√©els sont inclus comme premi√®res et derni√®res √©tiquettes
    if (!(round(min_conso, 2) %in% round(custom_breaks, 2))) {
      custom_breaks <- sort(unique(c(custom_breaks, min_conso)))
    }
    if (!(round(max_conso, 2) %in% round(custom_breaks, 2))) {
      custom_breaks <- sort(unique(c(custom_breaks, max_conso)))
    }
    
    # Mise en forme des √©tiquettes (arrondi √† 2 d√©cimales)
    custom_labels <- paste0(round(custom_breaks, 2), " MWh")


    # --- 2. Pr√©paration du Tooltip et Cr√©ation du graphique ggplot interactif ---
    france_departements_final_reactive <- france_departements_final_reactive %>%
      mutate(
        display_conso = ifelse(is.na(conso_moyenne_par_logement_MWh), 
                               "Donn√©es non disponibles", 
                               paste0(conso_moyenne_par_logement_MWh, " MWh/logement")),
                               
        tooltip_text = paste0(
          "D√©partement : ", NOM_DEP, " (", INSEE_DEP, ")", "\n",
          "Conso moyenne : ", display_conso
        )
      )
      
    titre_map <- paste0(
        "Consommation moyenne par logement (MWh) par D√©partement\n", 
        "Ann√©e ", input$Annee
    )

    gg_map <- ggplot(data = france_departements_final_reactive) +
      geom_sf_interactive(
        aes(
          fill = conso_moyenne_par_logement_MWh,
          tooltip = tooltip_text, 
          data_id = INSEE_DEP      
        ),
        color = "gray",
        linewidth = 0.1
      ) +
      scale_fill_distiller(
        palette = "Greens",
        name = "Conso moyenne (MWh/logement)",
        direction = 1,
        na.value = "lightgray",
        
        breaks = custom_breaks, 
        labels = custom_labels,
        guide = guide_colorbar(title.position = "top", title.hjust = 0.5) 
      ) +
      labs(
        title = titre_map
      ) +
      theme_minimal() +
      theme(
        # *** CORRECTION 1 : D√©placement de la l√©gende √† gauche ***
        legend.position = "left", 
        
        # *** CORRECTION 2 : R√©initialisation de la marge pour centrer la carte ***
        plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm"), 
        
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 9, face = "bold"),
        
        plot.title = element_text(hjust = 0.5, face = "bold", size = 10),
        axis.title = element_blank(),
        axis.text = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
      )

    # Retourne l'objet girafe
    girafe(ggobj = gg_map)
})

# --- PARTIE D'AFFICHAGE (UI) ---
girafeOutput("ma_carte_interactive", height = "600px")
```


Visualisation des tendances
=====================================

column
-------------------------------------
```{r setup_theme, include=FALSE}
theme_set(
  theme_minimal(base_size = 12) +
    theme(
      plot.title = element_text(size = 14, face = "bold", hjust = 0.5),
      axis.title = element_text(size = 12, face = "bold"),
      axis.text = element_text(size = 10),
      legend.position = "none"
    )
)

```




### 

```{r echo=FALSE}
renderPlot({
  ggplot(df %>% filter(!is.na(etiquette_dpe)), 
         aes(x = etiquette_dpe, 
             y = conso_moy_adresse_kwh, 
             fill = etiquette_dpe)) +
    geom_boxplot(outlier.size = 0.8, notch = FALSE) +
    stat_summary(fun = mean, geom = "point", shape = 18, size = 2, colour = "red") +
    labs(title = "Distribution de la consommation mesuree par classe DPE",
         x = "Classe DPE", y = "Consommation mesuree (kWh / an)") +
    coord_cartesian(ylim = c(0,12000))+
    scale_y_continuous(labels = comma) +
    scale_fill_manual(
      values = c(
        "A" = "#00B050", "B" = "#92D050", "C" = "#b8f774",
        "D" = "#FFFF00", "E" = "#FFC000", "F" = "#ED7D31", "G" = "#C00000" 
      )
    ) +
   theme(plot.title = element_text(face = "bold"), 
         axis.title = element_text(face = "bold"))
})
```



###

```{r echo= FALSE}
renderPlot({
  stats_dpe %>%
    ggplot(aes(x = etiquette_dpe, y = mean_kwh, fill = etiquette_dpe)) +
    geom_col() +
    geom_errorbar(aes(ymin = mean_kwh - sd_kwh, ymax = mean_kwh + sd_kwh), width = 0.2) +
    labs(title = "Consommation moyenne par classe DPE ",
         x = "Classe DPE", y = "Moyenne consommation (kWh / an)") +
    scale_y_continuous(labels = comma)  +
    scale_fill_manual(
      values = c(
        "A" = "#00B050", "B" = "#92D050", "C" = "#b8f774",
        "D" = "#FFFF00", "E" = "#FFC000", "F" = "#ED7D31", "G" = "#C00000" 
      )
    ) +
    theme(plot.title = element_text(face = "bold"), 
          axis.title = element_text(face = "bold"))
})
```

column 
-------------------------------------

###

```{r include=FALSE}
heat_df <- diffs_df %>% mutate(de_class = factor(de_class, levels = dpe_levels),
                               ala_class = factor(ala_class, levels = dpe_levels))
```

```{r}
renderPlot({
  ggplot(heat_df %>% drop_na(), aes(x = ala_class, y = de_class, fill = diff_kwh)) +
    geom_tile() +
    geom_text(aes(label = round(diff_kwh)), size = 3) +
    labs(title = "Difference de consommation moyenne (kWh/an) ",
         x = "vers", y = "depuis", fill = "kWh") +
    scale_fill_gradient2(
      low = "#00B050",
      high = "#C00000"
    ) +
    theme(plot.title = element_text(face = "bold"), 
          axis.title = element_text(face = "bold"))
})


```

###

```{r}
renderPlot({
  ggplot(df %>% filter(!is.na(conso_m2_kwh_an) & !is.na(etiquette_dpe)),
                 aes(x = etiquette_dpe, y = conso_m2_kwh_an, fill = etiquette_dpe)) +
    geom_boxplot() +
    stat_summary(fun = mean, geom = "point", shape = 18, size = 2, colour = "red") +
    labs(title = "Consommation normalisee (kWh/m2.an) par classe DPE",
         x = "Classe DPE", y = "kWh / m2 / an") +
    scale_fill_manual(
      values = c(
        "A" = "#00B050", "B" = "#92D050", "C" = "#b8f774",
        "D" = "#FFFF00", "E" = "#FFC000", "F" = "#ED7D31", "G" = "#C00000" 
    )
      ) +
    theme(plot.title = element_text(face = "bold"), 
          axis.title = element_text(face = "bold"))
})
```

Synth√®se
======================================

Ce dashboard a √©t√© fait dans le cadre du [open data university challenge](https://latitudes.notion.site/Saison-4-Espace-tudiants-et-tudiantes-Open-Data-University-242ff5903e5a806c969fe369fd105aa2https://latitudes.notion.site/Saison-4-Espace-tudiants-et-tudiantes-Open-Data-University-242ff5903e5a806c969fe369fd105aa2) les bases de donn√©es proviennent de [Defis.data.gouv](https://defis.data.gouv.fr/defis/diagnostics-de-performance-energetique)

En tant qu'apprentis √©conomistes, ce dashboard R/Flexdashboard est notre r√©ponse concr√®te au d√©fi de la performance √©nerg√©tique.
Nous avons structur√© cet outil pour transformer des donn√©es brutes DPE en une feuille de route claire pour la r√©novation.

Le dashboard commence par un diagnostic technique pr√©cis de la r√©partition des classes DPE dans l'√©chantillon analys√©.
Notre analyse quantifie rigoureusement la consommation r√©elle (kWh) par classe √©nerg√©tique et selon le type de chauffage.

L'innovation cl√© r√©side dans la cartographie interactive, permettant de cibler les d√©partements ayant la consommation la plus √©lev√©e.Nous avons √©galement mod√©lis√©, via une heatmap, les gains √©nerg√©tiques potentiels d'une r√©novation.

Cette quantification des √©conomies (kWh/an) par changement de classe DPE est notre outil d'aide √† la d√©cision majeur.

Tout ce que pr√©sente ce dashboard est le fruit d'un traitement de donn√©es rigoureux en plusieurs √©tapes :

**Pr√©paration**: Nettoyage des donn√©es brutes, conversion des unit√©s (MWh en kWh), et normalisation des √©tiquettes DPE.

**Calcul d'Indicateurs**: Cr√©ation des indicateurs cl√©s (consommation/m¬≤, statistiques descriptives) et calcul strat√©gique des gains potentiels de r√©novation (heatmap).

**Spatialisation** : Agr√©gation des consommations par d√©partement et jointure des donn√©es pour la cartographie.

Ce travail a √©t√© r√©alis√© par :

- [Ndeye Fatou Diop](https://www.linkedin.com/in/nd√®ye-fatou-diop-6b88b8218)
- [Kenny JEAN-ELIE](https://www.linkedin.com/in/kenny-jean-elie-b84175304/)
- [Bah Ibrahima Caba](https://www.linkedin.com/in/ibrahima-caba-bah-3a8419258)





